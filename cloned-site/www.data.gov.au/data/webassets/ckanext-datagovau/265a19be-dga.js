ckan.module("dga-setup",function($){"use strict";function correctNums(){_repTag("dl","p");_repTag("dt","span");_repTag("dd","span");}
function _repTag(old,updated){$(old).each(function(){$(this).replaceWith($("<"+updated+">").html($(this).html()).addClass(old),);});}
correctNums();document.querySelectorAll('[data-module="tooltip"]').forEach((el)=>bootstrap.Tooltip.getOrCreateInstance(el));});ckan.module("-dga-dashboard",function($){const origin=ckan.module.registry["dashboard"];if(!origin){console.warn("CKAN `dashboard` module cannot be found.");return;}
origin.prototype.initialize=function(){$.proxyAll(this,/_on/);this.button=$('#followee-filter .btn').on('click',this._onShowFolloweeDropdown);};origin.prototype._onInitSearch=function(){var input=$("input",this.popover);if(!input.hasClass("inited")){input.on("keyup",this._onSearchKeyUp).addClass("inited");}}});ckan.module("dga-breadcrumbs",function($){"use strict";return{initialize:function(){this.$(".breadcrumb li a").each(function(){if(this.innerText&&this.innerHTML){this.innerHTML='<h3 class="nav-styled">'+this.innerHTML+"</h3>";}else{$(this).html($('<h3 class="nav-styled">').html($(this).html()));}});},};});ckan.module("dga-chartjs",function($){"use strict";const DEFAULT_SCALE={grace:"5%",ticks:{precision:0}};function fakeData(){const labels=["January","February","March","April","May","June","June","June",];const data={labels:labels,datasets:[{label:"My First dataset",backgroundColor:"rgb(255, 99, 132)",borderColor:"rgb(255, 99, 132)",data:[0,10,5,2,20,30,45],},],};return data;}
return{options:{type:"line",data:null,dataUrl:null,dataAction:null,actionParams:null,options:{},defaultOptions:{scales:{x:DEFAULT_SCALE,y:DEFAULT_SCALE},borderWidth:1,}},initialize:function(){if(this.el.is("canvas")){this.canvas=this.el[0];}else{this.canvas=document.createElement("canvas");this.el.append(this.canvas);}
this.buildChart();},buildChart:async function(){const ctx=this.canvas.getContext("2d");const options=this.getOptions();const data=await this.getData();const type=this.options.type;this.chart=new Chart(ctx,{type,data,options});},getOptions:function(){return $.extend(true,{},this.options.defaultOptions,this.options.options);},getData:async function(){const{data:data,dataUrl:url,dataAction:action,actionParams:params,}=this.options;if(action){const remoteData=await new Promise((ok,err)=>this.sandbox.client.call("GET",action,"?"+new URLSearchParams(params),(resp)=>ok(resp.success?resp.result:null),(error)=>{console.warn("Data fetch error",err);ok(null);}));return remoteData;}else{return data||fakeData();}},};});this.ckan.module('dga-facet-filter',function($,_){"use strict";return{options:{category:"items",},initialize:function(){$.proxyAll(this,/_on/);const ul=this.el.closest('.facet-search-input')[0].nextElementSibling;const targetSelector='#'+ul.id;const form=document.querySelector(`form[hx-target="${targetSelector}"]`);if(!form){console.error('Facet form not found for',targetSelector);return;}
const self=this;const afterSwapHandler=(e)=>{if(e.detail.target===ul){htmx.off("htmx:afterSwap",afterSwapHandler);self.ulElement=ul;self._postFacetInit();}};htmx.on("htmx:afterSwap",afterSwapHandler);htmx.trigger(form,"dga:load-facets");},_postFacetInit:function(){this._hideChildren=this._hideChildren.bind(this);this._onInputChange=this._onInputChange.bind(this);this._checkForHiddenness=this._checkForHiddenness.bind(this);this._deleteEmptyEl=this._deleteEmptyEl.bind(this);this._showMoreItems=this._showMoreItems.bind(this);this._showLessItems=this._showLessItems.bind(this);this._countVisibleChildren=this._countVisibleChildren.bind(this);this.ulElement=this.el.closest('.facet-search-input')[0].nextElementSibling;this.children=this.ulElement.querySelectorAll("li");this.showMoreButton=$(this.ulElement).next('.module-footer');this.showMoreButton.find('.show-more').on('click',this._showMoreItems);this.showMoreButton.find('.show-less').on('click',this._showLessItems);this.isShowAll=false;this.input=this.el;$(this.input).on("input",this._onInputChange);this.clearBtn=$(this.input).siblings('.clear-btn');this.clearBtn.on('click',this._onClearClick.bind(this));this._onInputChange();},_checkForHiddenness:function(){if(this._isAllHidden(this.children)){if(this.ulElement.querySelector("nav.empty")){return;}
const emptyEl=document.createElement("nav");emptyEl.classList.add("py-2","empty");emptyEl.textContent="There are no "+this.options.category+" that match this search.";this.ulElement.appendChild(emptyEl);}else{this._deleteEmptyEl();}},_isAllHidden:function(children){for(var i=0;i<children.length;i++){if(!children[i].hidden){return false;}}
return true;},_deleteEmptyEl:function(){const emptyEl=this.ulElement.querySelector("nav.empty");if(emptyEl)emptyEl.remove();},_onInputChange:function(){const val=this.input.val().toLowerCase();for(var i=0;i<this.children.length;i++){this.children[i].hidden=!~(this.children[i].querySelector(".item-label").textContent.toLowerCase()||"").indexOf(val);}
var hideOrShow=this._countVisibleChildren()>10;this.showMoreButton.toggleClass('hidden',!hideOrShow);this._hideChildren();},_hideChildren:function(){for(var i=0,shownItems=0;i<this.children.length;i++){if(!this.children[i].hidden)shownItems++;if(shownItems>10&&!this.isShowAll){this.children[i].hidden=true;}}
this._checkForHiddenness();},_showMoreItems:function(){this.isShowAll=true;this._onInputChange();$(this.input).closest('.facet-nav').addClass('show-all');},_showLessItems:function(){this.isShowAll=false;this._onInputChange();$(this.input).closest('.facet-nav').removeClass('show-all');},_countVisibleChildren:function(){var counter=0;for(var i=0;i<this.children.length;i++){if(!this.children[i].hidden)counter++;}
return counter;},_onClearClick:function(){this.input.val('');this._onInputChange();this.input.focus();}};});ckan.module("dga-scroll-to-top",function($){"use strict";return{initialize:function(){$.proxyAll(this,/_/);this.el.on("click",this._scrollToTop);$(window).on("scroll",this._toggleVisibility);this._toggleVisibility();},_scrollToTop:function(e){if(e.type==='keydown'&&e.keyCode!==13&&e.keyCode!==32){return;}
e.preventDefault();$('body, html').animate({scrollTop:0},400);},_toggleVisibility:function(e){if($(document).scrollTop()>150){this.el.fadeIn();}else{this.el.fadeOut();}},};});ckan.module("dga-resource-show-more",function($){"use strict";return{options:{},initialize:function(){var self=this;this.$("#show-more-resources").click(function(){$(".resource-more").each(function(){$(this).toggleClass('d-none');});$(this).toggleClass('show-more');if($(this).hasClass("show-more")){$(this).text(self._('Show more'));}else{$(this).text(self._('Show less'));}});},};});ckan.module("dga-align-activity",function($){return{initialize:function(){this.el.find("li.item").each(function(){const $li=$(this);$li.children("span").has("img.user-image").has("a[href^='/user/'], a[href^='/data/user/']").contents().unwrap();const clone=$li.clone();clone.find("span, img, a, br").remove();const extractedText=clone.text().trim();if(extractedText){$li.html($li.html().replace(extractedText,"").trim());}
const $userLink=$li.find("a[href^='/user/'], a[href^='/data/user/']").first();if($userLink.length){const $nextLink=$li.find("a").not($userLink).first();const $span=$('<span class="activity-text"></span>');$span.append($userLink);if(extractedText){$span.append($('<span></span>').text(" "+extractedText+" "));}
if($nextLink.length){$span.append($nextLink);}
const $avatar=$li.find("img.user-image");$avatar.length?$avatar.after($span):$li.prepend($span);}});}};});ckan.module("dga-nav-tabs",function($){return{initialize:function(){const module=this;const adjustFlexContainerClasses=function(){const $container=module.el;const $items=$container.children();if(!$items.length)return;let rowCount=1;let prevOffsetTop=$items.eq(0).offset().top;$items.each(function(i){if(i===0)return;const currentOffsetTop=$(this).offset().top;if(currentOffsetTop!==prevOffsetTop){rowCount++;prevOffsetTop=currentOffsetTop;}});if(rowCount>1){$container.addClass("mb-2");}else{$container.removeClass("mb-2");}};adjustFlexContainerClasses();$(window).on("resize",adjustFlexContainerClasses);}};});ckan.module("dga-include-children",function($){"use strict";return{options:{},initialize:function(){this.el.on("click",this._onClick);},_onClick:function(e){if($("#include_children").is(":checked")){$("#organization-datasets-search-form").submit();}else{const url=new URL(window.location.href);const param="include_children"
if(url.searchParams.has(param)){url.searchParams.delete(param);window.history.pushState({},'',url);window.location.reload();}}},};});ckan.module("dga-date-range-selector",function($){return{options:{startDate:null,endDate:null,startYear:new Date().getFullYear(),endYear:new Date().getFullYear(),},initialize:function(){$.proxyAll(this,/_on/);this.el.on("click","#date-trigger",this._onTriggerClick);this.el.on("click",".month-btn",this._onMonthSelect);this.el.on("click","#clear-btn",this._onClear);this.el.on("click","#apply-btn",this._onApply);this.el.on("click",".year-nav",this._onYearChange);this._initFromUrl();this._updateYearDisplays();this._updateDateDisplay();this._updateSelectedMonths();this._updateApplyButtonState();this._updateAvailability();},_onTriggerClick:function(e){e.stopPropagation();this.el.find("#calendar-dropdown").toggleClass("active");},_onYearChange:function(e){const $btn=$(e.target).closest(".year-nav");const isStart=$btn.attr("data-calendar")==="start";const increment=$btn.hasClass("next-year")?1:-1;const currentYear=new Date().getFullYear();const yearOption=isStart?"startYear":"endYear";const dateOption=isStart?"startDate":"endDate";if(this.options[yearOption]===currentYear&&increment===1)
return;this.options[yearOption]+=increment;if(this.options[dateOption]){const oldDate=this.options[dateOption];this.options[dateOption]=new Date(this.options[yearOption],oldDate.getMonth()+(isStart?0:1),isStart?1:0,);}
this._updateYearDisplays();this._updateDateDisplay();this._updateSelectedMonths();this._validateDateRange();this._updateAvailability();},_onMonthSelect:function(e){const $btn=$(e.target);const monthIndex=$btn.index();const isStartCalendar=$btn.closest("#start-calendar").length>0;const selectedYear=isStartCalendar?this.options.startYear:this.options.endYear;const dateOption=isStartCalendar?"startDate":"endDate";if(isStartCalendar){this.options[dateOption]=new Date(selectedYear,monthIndex,1,);}else{this.options[dateOption]=new Date(selectedYear,monthIndex+1,0,);}
if(this.options.startDate&&this.options.endDate&&this.options.startDate>this.options.endDate){this.options.endDate=null;}else if(this.options.endDate&&this.options.startDate&&this.options.endDate<this.options.startDate){this.options.endDate=null;}
this._updateSelectedMonths();this._updateDateDisplay();this._updateApplyButtonState();this._updateAvailability();},_onClear:function(){this.options.startDate=null;this.options.endDate=null;this.options.startYear=new Date().getFullYear();this.options.endYear=new Date().getFullYear();this._updateYearDisplays();this._updateSelectedMonths();this._updateDateDisplay();this._updateApplyButtonState();const url=this._updateUrlParams(null,null);window.history.replaceState({},"",url.toString());window.location.reload();},_onApply:function(){if(!this.options.startDate||!this.options.endDate)return;const url=this._updateUrlParams(this._formatDate(this.options.startDate),this._formatDate(this.options.endDate),);this.el.find("#calendar-dropdown").removeClass("active");window.location.href=url.toString();},_updateUrlParams:function(startDate,endDate){const url=new URL(window.location.href);url.searchParams.delete("page");if(startDate){url.searchParams.set("ext_startdate",startDate);}else{url.searchParams.delete("ext_startdate");}
if(endDate){url.searchParams.set("ext_enddate",endDate);}else{url.searchParams.delete("ext_enddate");}
return url;},_updateYearDisplays:function(){this.el.find("#start-year").text(this.options.startYear);this.el.find("#end-year").text(this.options.endYear);},_updateSelectedMonths:function(){this.el.find(".month-btn").removeClass("selected");[{date:this.options.startDate,calendar:"#start-calendar"},{date:this.options.endDate,calendar:"#end-calendar"},].forEach(({date,calendar})=>{if(date){const month=date.getMonth();this.el.find(`${calendar} .month-btn:eq(${month})`).addClass("selected");this.el.find(".month-btn").addClass("active");this.el.find(".current-year").addClass("active");}});},_updateDateDisplay:function(){const formatDate=(date)=>date?date.toLocaleDateString("en-US",{year:"numeric",month:"short",}):"";const startDateText=formatDate(this.options.startDate)||"Start date";const endDateText=formatDate(this.options.endDate)||"End date";this.el.find("#date-display-start").text(startDateText);this.el.find("#date-display-end").html(`
                <span id="date-display-end">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_3090_6506)">
                            <rect width="16" height="16" transform="translate(-0.00195312)" fill="white" fill-opacity="0.01"/>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M3.99805 8C3.99805 7.86739 4.05073 7.74021 4.14449 7.64645C4.23826 7.55268 4.36544 7.5 4.49805 7.5H10.291L8.14405 5.354C8.05016 5.26011 7.99742 5.13277 7.99742 5C7.99742 4.86722 8.05016 4.73989 8.14405 4.646C8.23793 4.55211 8.36527 4.49937 8.49805 4.49937C8.63082 4.49937 8.75816 4.55211 8.85205 4.646L11.852 7.646C11.8986 7.69244 11.9356 7.74762 11.9608 7.80836C11.986 7.86911 11.9989 7.93423 11.9989 8C11.9989 8.06577 11.986 8.13089 11.9608 8.19163C11.9356 8.25238 11.8986 8.30755 11.852 8.354L8.85205 11.354C8.75816 11.4479 8.63082 11.5006 8.49805 11.5006C8.36527 11.5006 8.23793 11.4479 8.14405 11.354C8.05016 11.2601 7.99742 11.1328 7.99742 11C7.99742 10.8672 8.05016 10.7399 8.14405 10.646L10.291 8.5H4.49805C4.36544 8.5 4.23826 8.44732 4.14449 8.35355C4.05073 8.25978 3.99805 8.13261 3.99805 8Z" fill="#757575"/>
                        </g>
                        <defs>
                            <clipPath id="clip0_3090_6506">
                                <rect width="16" height="16" fill="white" transform="translate(-0.00195312)"/>
                            </clipPath>
                        </defs>
                    </svg>
                    ${endDateText}
                </span>
            `);},_validateDateRange:function(){if(this.options.startDate&&this.options.endDate&&this.options.startDate>this.options.endDate){this.options.endDate=null;this._updateSelectedMonths();this._updateDateDisplay();this._updateApplyButtonState();}},_updateApplyButtonState:function(){const hasDates=this.options.startDate&&this.options.endDate;this.el.find("#apply-btn, #clear-btn").prop("disabled",!hasDates).toggleClass("disabled",!hasDates);},_formatDate:function(date){return date.toLocaleDateString("en-CA",{year:"numeric",month:"2-digit",day:"2-digit",});},_initFromUrl:function(){const urlParams=new URLSearchParams(window.location.search);const urlStartDate=urlParams.get("ext_startdate");const urlEndDate=urlParams.get("ext_enddate");if(urlStartDate){this.options.startDate=new Date(urlStartDate);this.options.startYear=this.options.startDate.getFullYear();}
if(urlEndDate){this.options.endDate=new Date(urlEndDate);this.options.endYear=this.options.endDate.getFullYear();}},_updateAvailability(){const now=new Date();const startYear=this.el.find("#start-year");const endYear=this.el.find("#end-year");const startCalendar=this.el.find("#start-calendar");const endCalendar=this.el.find("#end-calendar");startYear.next().prop("disabled",startYear.text()>=endYear.text());endYear.prev().prop("disabled",startYear.text()>=endYear.text());endYear.next().prop("disabled",endYear.text()>=now.getFullYear());if(startYear.text()===endYear.text()){if(this.options.startDate){const buttons=endCalendar.find(".month-btn");const split=this.options.startDate.getMonth();buttons.slice(0,split).prop("disabled",true);buttons.slice(split).prop("disabled",false);}
if(this.options.endDate){const buttons=startCalendar.find(".month-btn");const split=this.options.endDate.getMonth()+1;buttons.slice(0,split).prop("disabled",false);buttons.slice(split).prop("disabled",true);}}else{startCalendar.add(endCalendar).find(".month-btn").prop("disabled",false);}},};});ckan.module("dga-range-slider",function($){return{options:{reflect:null,},initialize(){const reflect=$(this.options.reflect);console.log(this.el,reflect);this.el.on("change",(e)=>reflect.val(e.target.value||0));reflect.on("input",(e)=>this.el.val(e.target.value||0));},};});ckan.module("dga-about-preview",function($){"use strict";return{options:{fullText:""},initialize:function(){var self=this;let paragraph=self.$(".about-preview");let fullText=self.options.fullText;let shortText=fullText.substring(0,30)+"...";paragraph.html(shortText);this.$(".about-read-more").click(function(){if($(this).hasClass("show-less")){paragraph.html(shortText);$(this).text(self._("Show More"));}else{paragraph.html(fullText);$(this).text(self._("Show Less"));}
$(this).toggleClass("show-less")});},};});ckan.module("dga-delete-sysadmin",function($){return{initialize:function(){const modal=document.getElementById("deleteSysadminModal");if(!modal)return;this.el.find(".btn-danger").each(function(){const $button=$(this);const $form=$button.closest("form");modal.addEventListener("show.bs.modal",function(event){if(event.relatedTarget===$button[0]){const $confirmButton=$(modal).find("#confirmDelete");$confirmButton.attr("form",$form.attr("id"));console.log($confirmButton)}});});}};});this.ckan.module('dga-resource-upload-field',function(jQuery){var _nameIsDirty=!!$('input[name="name"]').val();var urlField=$('#field-resource-url');return{initialize:function(){$('input[name="name"]').on('change',function(){_nameIsDirty=true;});if($('#resource-url-upload').prop('checked')){urlField.attr('type','text');}
$('#resource-link-button').on('click',function(){urlField.attr('type','url');})
$('#field-resource-upload').on('change',function(){if(_nameIsDirty){return;}
var file_name=$(this).val().split(/^C:\\fakepath\\/).pop();var isIE=!!document.documentMode;var isEdge=!isIE&&!!window.StyleMedia;if(isIE||isEdge){var fName=file_name.match(/[^\\\/]+$/);file_name=fName?fName[0]:file_name;}
file_name=file_name.replace(/\.[^/.]+$/,'');$('input[name="name"]').val(file_name);});}}});ckan.module("dga-select2",function($){return{options:{minimumResultsForSearch:10},initialize(){this.el.select2(this.options);},};});ckan.module("dga-class-toggle",function($){return{options:{event:"click",className:"active",},initialize(){this.el.on(this.options.event,()=>this.el.toggleClass(this.options.className),);},};});ckan.module('dga-url-helptext',function($,_){return{initialize:function(){const $urlField=$('#field-name');if(!$urlField.length)return;const $urlGroup=$urlField.closest('.form-group');const $helpBlock=$urlGroup.find('.info-block');if(!$helpBlock.length)return;const $originalParent=$helpBlock.parent();function updatePlacement(){const isHidden=$urlGroup.is(':hidden');const inTempWrapper=$helpBlock.parent('.url-helptext-wrapper').length;if(isHidden&&!inTempWrapper){const $wrapper=$('<div>',{class:'form-group url-helptext-wrapper'});$helpBlock.appendTo($wrapper);$urlGroup.after($wrapper);}
if(!isHidden&&inTempWrapper){console.log("here")
$helpBlock.parent('.url-helptext-wrapper').remove();$helpBlock.appendTo($originalParent);}}
updatePlacement();const observer=new MutationObserver(updatePlacement);observer.observe($urlGroup[0],{attributes:true,attributeFilter:['style','class']});this.el.data('dga-url-help-text-observer',observer);},};});ckan.module('dga-send-button',function($){return{initialize:function(){const $btn=this.el;const $form=$btn.closest('form');$form.one('submit',function(){$btn.prop('disabled',true).text('Sendingâ€¦');});}};});